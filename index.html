<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>GlassBlocks</title>

<link rel="icon" href="favicon.ico">
<link href="https://fonts.googleapis.com/css2?family=Shizuru&display=swap" rel="stylesheet">

<style>
:root{
  --gap: 6px;
  --radius: 10px;
  --piece-pad: 10px;
}

*{ box-sizing:border-box; user-select:none; -webkit-tap-highlight-color:transparent; }

body{
  margin:0;
  font-family:'Shizuru', cursive;
  letter-spacing:.5px;
  color:#fff;
  background: radial-gradient(circle at top, #1e293b, #0f172a);
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}

/* emoji rain */
.emoji-rain{
  position:fixed;
  inset:0;
  pointer-events:none;
  z-index:0;
}
.emoji{
  position:absolute;
  top:-20%;
  opacity:.32;
  animation: fall linear infinite, drift ease-in-out infinite;
}
@keyframes fall{ to{ transform:translateY(130vh); } }
@keyframes drift{
  0%{ margin-left:0; }
  50%{ margin-left:24px; }
  100%{ margin-left:0; }
}

/* game layout */
.game{
  position:relative;
  z-index:2;
  width:min(520px,94vw);
  display:flex;
  flex-direction:column;
  gap:16px;
}

.header{
  display:flex;
  justify-content:space-between;
  font-size:20px;
}

/* board */
.board{
  max-width:420px;
  aspect-ratio:1;
  align-self:center;
  display:grid;
  grid-template-columns:repeat(8,1fr);
  gap:var(--gap);
  padding:var(--gap);
  background:rgba(30,41,59,.75);
  border-radius:22px;
  box-shadow:0 25px 60px rgba(0,0,0,.6);
}

.cell{
  background:rgba(15,23,42,.65);
  border-radius:var(--radius);
}
.cell.filled{
  box-shadow:0 0 12px var(--glow);
}
.cell.clearing{
  animation:clear .4s forwards;
}
@keyframes clear{
  to{ opacity:0; transform:scale(.7); }
}

/* tray */
.tray{
  background:rgba(30,41,59,.55);
  border-radius:22px;
  padding:20px;
  min-height:210px;
}
.pieces{
  display:flex;
  justify-content:space-around;
  align-items:center;
  height:150px;
}

/* pieces */
.piece{
  display:grid;
  gap:var(--gap);
  padding:var(--piece-pad);
  cursor:grab;
}
.piece.dragging{ opacity:0; }

.piece-cell{
  border-radius:6px;
  background:linear-gradient(135deg,var(--c1),var(--c2));
  box-shadow:0 0 10px var(--c2);
}

/* drag proxy */
.drag-proxy{
  position:fixed;
  pointer-events:none;
  display:grid;
  gap:var(--gap);
  padding:var(--piece-pad);
  z-index:9999;
  filter:drop-shadow(0 20px 30px rgba(0,0,0,.6));
}

/* ability indicator */
.ability{
  position:fixed;
  top:14px;
  left:50%;
  transform:translateX(-50%);
  font-size:18px;
  opacity:.85;
}

/* audio button */
.audio-btn{
  position:fixed;
  bottom:14px;
  right:14px;
  background:rgba(30,41,59,.7);
  border-radius:999px;
  padding:10px 14px;
  cursor:pointer;
}

/* game over */
.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  display:none;
  align-items:center;
  justify-content:center;
}
.overlay.show{ display:flex; }
.modal{
  background:rgba(30,41,59,.9);
  padding:30px;
  border-radius:20px;
}
</style>
</head>

<body>

<audio id="bgm" src="music.mp3" loop></audio>
<audio id="sfx" src="click.mp3"></audio>

<div id="ability" class="ability"></div>
<button id="audioBtn" class="audio-btn">ðŸ”‡</button>

<div class="emoji-rain" id="rain"></div>

<div class="game">
  <div class="header">
    <div>Score: <span id="score">0</span></div>
  </div>

  <div id="board" class="board"></div>

  <div class="tray">
    <div id="pieces" class="pieces"></div>
  </div>
</div>

<div id="proxy" class="drag-proxy" style="display:none;"></div>

<div id="gameOver" class="overlay">
  <div class="modal">
    <h2>No Space Left</h2>
    <p>Final Score: <span id="finalScore">0</span></p>
    <button onclick="location.reload()">Restart</button>
  </div>
</div>

<script>
/* ---------- AUDIO ---------- */
const bgm = document.getElementById('bgm');
const sfx = document.getElementById('sfx');
const audioBtn = document.getElementById('audioBtn');
let audioOn = false;
let unlocked = false;

function unlockAudio(){
  if(unlocked) return;
  unlocked = true;
  bgm.volume = .35;
  sfx.volume = .6;
  bgm.play().then(()=>bgm.pause()).catch(()=>{});
}
audioBtn.onclick = () => {
  unlockAudio();
  audioOn = !audioOn;
  audioBtn.textContent = audioOn ? 'ðŸ”Š' : 'ðŸ”‡';
  if(audioOn) bgm.play().catch(()=>{});
  else bgm.pause();
};
function clickSound(){
  if(audioOn){
    sfx.currentTime = 0;
    sfx.play().catch(()=>{});
  }
}
window.addEventListener('pointerdown', unlockAudio, { once:true });

/* ---------- RAIN ---------- */
const rain = document.getElementById('rain');
['âœ¯','âœ¦','âœ§','âœ©','â˜…','â˜†','â­‘'].forEach(()=>{});
for(let i=0;i<50;i++){
  const e=document.createElement('span');
  e.className='emoji';
  e.textContent=['âœ¯','âœ¦','âœ§','âœ©','â˜…','â˜†','â­‘'][Math.random()*7|0];
  e.style.left=Math.random()*100+'%';
  e.style.fontSize=12+Math.random()*18+'px';
  e.style.animationDuration=(10+Math.random()*20)+'s';
  e.style.animationDelay=(-Math.random()*20)+'s';
  rain.appendChild(e);
}

/* ---------- GAME ---------- */
const GRID=8;
const COLORS=[
  {c1:'#22d3ee',c2:'#67e8f9'},
  {c1:'#a78bfa',c2:'#c4b5fd'},
  {c1:'#34d399',c2:'#6ee7b7'},
  {c1:'#f472b6',c2:'#f9a8d4'},
  {c1:'#facc15',c2:'#fde68a'}
];

const BASE=[
  [[1]],[[1,1]],[[1,1,1]],[[1,1,1,1]],
  [[1,1],[1,1]],[[1,1,1],[0,1,0]],
  [[0,1,1],[1,1,0]],[[1,0],[1,0],[1,1]]
];

function rot(s){return s[0].map((_,i)=>s.map(r=>r[i]).reverse());}
function flip(s){return s.map(r=>[...r].reverse());}

let shapes=[];
BASE.forEach(b=>{
  let c=b;
  for(let i=0;i<4;i++){
    shapes.push(c,flip(c));
    c=rot(c);
  }
});

let board=[...Array(GRID)].map(()=>Array(GRID).fill(null));
let score=0;
let ability=null; // 'flip' or 'rotate'

const abilityEl=document.getElementById('ability');
const boardEl=document.getElementById('board');
const piecesEl=document.getElementById('pieces');
const proxy=document.getElementById('proxy');
const scoreEl=document.getElementById('score');

/* board */
for(let r=0;r<GRID;r++)
  for(let c=0;c<GRID;c++){
    const d=document.createElement('div');
    d.className='cell';
    d.dataset.r=r; d.dataset.c=c;
    boardEl.appendChild(d);
  }

/* spawn */
function spawn(){
  piecesEl.innerHTML='';
  for(let i=0;i<3;i++){
    const shape=JSON.parse(JSON.stringify(shapes[Math.random()*shapes.length|0]));
    const col=COLORS[Math.random()*COLORS.length|0];
    const p=document.createElement('div');
    p.className='piece';
    p._shape=shape;
    p._color=col;
    p.style.gridTemplateColumns=`repeat(${shape[0].length},1fr)`;
    shape.flat().forEach(v=>{
      const c=document.createElement('div');
      if(v){
        c.className='piece-cell';
        c.style.setProperty('--c1',col.c1);
        c.style.setProperty('--c2',col.c2);
      }
      p.appendChild(c);
    });
    p.onpointerdown=e=>dragStart(e,p);
    piecesEl.appendChild(p);
  }
}
spawn();

/* drag */
let drag=null;
function dragStart(e,p){
  unlockAudio();
  drag={p,shape:p._shape,color:p._color,ox:e.offsetX,oy:e.offsetY};
  p.classList.add('dragging');

  // apply ability ON PICKUP
  if(ability==='flip'){ drag.shape=flip(drag.shape); ability=null; }
  if(ability==='rotate'){ drag.shape=rot(drag.shape); ability=null; }
  abilityEl.textContent='';

  proxy.innerHTML='';
  proxy.style.display='grid';
  proxy.style.gridTemplateColumns=`repeat(${drag.shape[0].length},1fr)`;
  drag.shape.flat().forEach(v=>{
    const d=document.createElement('div');
    if(v){
      d.className='piece-cell';
      d.style.setProperty('--c1',drag.color.c1);
      d.style.setProperty('--c2',drag.color.c2);
    }
    proxy.appendChild(d);
  });

  window.onpointermove=e=>{
    proxy.style.left=e.clientX-drag.ox+'px';
    proxy.style.top=e.clientY-drag.oy+'px';
  };
  window.onpointerup=e=>drop(e);
}

function drop(e){
  window.onpointermove=null;
  window.onpointerup=null;
  const rect=boardEl.getBoundingClientRect();
  const size=rect.width/GRID;
  const r=Math.round((e.clientY-rect.top)/size);
  const c=Math.round((e.clientX-rect.left)/size);

  if(canPlace(drag.shape,r,c)){
    place(drag.shape,r,c,drag.color);
    drag.p.remove();
    clickSound();
    clearLines();
    if(!piecesEl.children.length) spawn();
  }else{
    drag.p.classList.remove('dragging');
  }
  proxy.style.display='none';
  drag=null;
}

function canPlace(s,r,c){
  for(let i=0;i<s.length;i++)
    for(let j=0;j<s[i].length;j++)
      if(s[i][j]){
        if(!board[r+i]||board[r+i][c+j]) return false;
      }
  return true;
}

function place(s,r,c,col){
  s.forEach((row,i)=>row.forEach((v,j)=>{
    if(v){
      board[r+i][c+j]=col;
      const el=document.querySelector(`.cell[data-r="${r+i}"][data-c="${c+j}"]`);
      el.classList.add('filled');
      el.style.background=`linear-gradient(135deg,${col.c1},${col.c2})`;
      el.style.setProperty('--glow',col.c2);
    }
  }));
  score+=10;
  scoreEl.textContent=score;
}

/* clearing + ability chance */
function clearLines(){
  let cleared=false;
  for(let r=0;r<GRID;r++)
    if(board[r].every(v=>v)){
      board[r].fill(null);
      document.querySelectorAll(`.cell[data-r="${r}"]`).forEach(c=>c.className='cell');
      cleared=true;
    }

  for(let c=0;c<GRID;c++)
    if(board.every(r=>r[c])){
      board.forEach(r=>r[c]=null);
      document.querySelectorAll(`.cell[data-c="${c}"]`).forEach(c=>c.className='cell');
      cleared=true;
    }

  if(cleared){
    clickSound();
    // ðŸŽ¯ ability roll
    const roll=Math.random();
    if(roll<0.15){
      ability='flip';
      abilityEl.textContent='Flip Ready â¬Œ';
    }else if(roll<0.30){
      ability='rotate';
      abilityEl.textContent='Rotate Ready âŸ³';
    }
  }
}
</script>
</body>
</html>
