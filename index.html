<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>GlassBlocks</title>

<link rel="icon" href="favicon.ico">
<link href="https://fonts.googleapis.com/css2?family=Shizuru&display=swap" rel="stylesheet">

<style>
:root{
  --gap:6px;
  --radius:10px;
  --piece-pad:10px;
}
*{box-sizing:border-box;user-select:none;-webkit-tap-highlight-color:transparent}
body{
  margin:0;
  font-family:'Shizuru',cursive;
  color:#fff;
  background:radial-gradient(circle at top,#1e293b,#0f172a);
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  overflow:hidden;
}
.emoji-rain{position:fixed;inset:0;pointer-events:none;z-index:0}
.emoji{
  position:absolute;
  top:-20%;
  opacity:.3;
  animation:fall linear infinite,drift ease-in-out infinite;
}
@keyframes fall{to{transform:translateY(130vh)}}
@keyframes drift{0%{margin-left:0}50%{margin-left:24px}100%{margin-left:0}}

.game{z-index:2;width:min(520px,94vw);display:flex;flex-direction:column;gap:14px}
.header{display:flex;justify-content:space-between;font-size:20px}

.board{
  max-width:420px;
  aspect-ratio:1;
  display:grid;
  grid-template-columns:repeat(8,1fr);
  gap:var(--gap);
  padding:var(--gap);
  background:rgba(30,41,59,.75);
  border-radius:22px;
  box-shadow:0 25px 60px rgba(0,0,0,.6);
}
.cell{
  background:rgba(15,23,42,.65);
  border-radius:var(--radius);
  box-shadow:inset 0 3px 6px rgba(0,0,0,.35);
}
.cell.filled{box-shadow:0 0 0 1px rgba(255,255,255,.15),0 0 12px var(--glow)}
.cell.clearing{animation:clear .42s ease-out forwards}
@keyframes clear{to{opacity:0;transform:scale(.7)}}

.tray{
  background:rgba(30,41,59,.55);
  border-radius:22px;
  padding:22px;
  min-height:210px;
}
.pieces{display:flex;justify-content:space-around;align-items:center;height:150px}
.piece{display:grid;gap:var(--gap);padding:var(--piece-pad);cursor:grab}
.piece.dragging{opacity:0}
.piece-cell{
  border-radius:6px;
  background:linear-gradient(135deg,var(--c1),var(--c2));
  box-shadow:0 0 10px var(--c2);
}
.drag-proxy{
  position:fixed;
  pointer-events:none;
  display:grid;
  gap:var(--gap);
  padding:var(--piece-pad);
  z-index:999;
}
.drag-proxy.wiggle{animation:wiggle .9s infinite}
@keyframes wiggle{50%{transform:translateY(-4px) scale(1.06)}}

.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:10;
}
.overlay.show{display:flex}
.modal{
  background:rgba(30,41,59,.95);
  padding:30px;
  border-radius:20px;
  text-align:center;
}
.audio-btn{
  position:fixed;
  bottom:14px;
  right:14px;
  background:rgba(30,41,59,.7);
  border-radius:999px;
  padding:10px 14px;
  cursor:pointer;
}
.audio-btn.off{opacity:.6}
.power-pill{
  position:fixed;
  top:14px;
  left:50%;
  transform:translateX(-50%);
  padding:8px 14px;
  border-radius:999px;
  background:rgba(30,41,59,.6);
  display:none;
}
</style>
</head>

<body>

<audio id="bgm" src="music.mp3" loop></audio>
<audio id="sfx" src="click.mp3"></audio>
<button id="audioBtn" class="audio-btn off">ðŸ”‡</button>
<div id="powerPill" class="power-pill"></div>
<div class="emoji-rain" id="rain"></div>

<div class="game">
  <div class="header">
    <div>Score: <span id="score">0</span></div>
    <div>Best: <span id="best">0</span></div>
  </div>
  <div id="board" class="board"></div>
  <div class="tray"><div id="pieces" class="pieces"></div></div>
</div>

<div id="proxy" class="drag-proxy"></div>

<div id="gameOver" class="overlay">
  <div class="modal">
    <h2>No Space Left</h2>
    <p>Final Score: <span id="finalScore"></span></p>
    <button id="restartBtn">Restart</button>
  </div>
</div>

<script>
/* AUDIO (FINAL FIX) */
const bgm=document.getElementById('bgm');
const sfx=document.getElementById('sfx');
const audioBtn=document.getElementById('audioBtn');
let audioEnabled=localStorage.getItem('gb_audio')==='1';
let unlocked=false;

function unlockAudio(){
  if(unlocked) return;
  unlocked=true;
  bgm.volume=.35; sfx.volume=.7;
  if(audioEnabled) bgm.play().catch(()=>{});
}
audioBtn.onclick=()=>{
  unlockAudio();
  audioEnabled=!audioEnabled;
  localStorage.setItem('gb_audio',audioEnabled?'1':'0');
  audioBtn.textContent=audioEnabled?'ðŸ”Š':'ðŸ”‡';
  audioBtn.classList.toggle('off',!audioEnabled);
  audioEnabled?bgm.play():bgm.pause();
};
window.addEventListener('pointerdown',unlockAudio,{once:true});
audioBtn.textContent=audioEnabled?'ðŸ”Š':'ðŸ”‡';
audioBtn.classList.toggle('off',!audioEnabled);
function click(){if(audioEnabled){sfx.currentTime=0;sfx.play().catch(()=>{})}}

/* RAIN */
const rain=document.getElementById('rain');
['âœ¯','âœ¦','âœ§','âœ©','â˜…','â˜†','â­‘'].forEach(()=>{});
for(let i=0;i<55;i++){
  const e=document.createElement('span');
  e.className='emoji';
  e.textContent=['âœ¯','âœ¦','âœ§','âœ©','â˜…','â˜†','â­‘'][Math.random()*7|0];
  e.style.left=Math.random()*100+'%';
  e.style.fontSize=12+Math.random()*18+'px';
  e.style.animationDuration=(10+Math.random()*18)+'s,'+(3+Math.random()*4)+'s';
  rain.appendChild(e);
}

/* GAME CORE */
const GRID=8;
const board=[...Array(GRID)].map(()=>Array(GRID).fill(null));
const boardEl=document.getElementById('board');
const piecesEl=document.getElementById('pieces');
const scoreEl=document.getElementById('score');
const bestEl=document.getElementById('best');
const overlay=document.getElementById('gameOver');
const finalScoreEl=document.getElementById('finalScore');
let score=0,best=+localStorage.getItem('gb_best')||0;
bestEl.textContent=best;

const COLORS=[
  {c1:'#22d3ee',c2:'#67e8f9'},
  {c1:'#a78bfa',c2:'#c4b5fd'},
  {c1:'#34d399',c2:'#6ee7b7'},
  {c1:'#f472b6',c2:'#f9a8d4'},
  {c1:'#facc15',c2:'#fde68a'}
];
const SHAPES=[[[1]],[[1,1]],[[1,1,1]],[[1,1,1,1]],[[1,1],[1,1]],[[1,1,1],[0,1,0]]];

function renderBoard(){
  boardEl.innerHTML='';
  for(let r=0;r<GRID;r++)for(let c=0;c<GRID;c++){
    const d=document.createElement('div');
    d.className='cell';d.dataset.r=r;d.dataset.c=c;
    boardEl.appendChild(d);
  }
}
function spawn(){
  piecesEl.innerHTML='';
  for(let i=0;i<3;i++){
    const s=SHAPES[Math.random()*SHAPES.length|0].map(r=>r.slice());
    const col=COLORS[Math.random()*COLORS.length|0];
    const p=document.createElement('div');
    p.className='piece';p._s=s;p._c=col;
    p.style.gridTemplateColumns=`repeat(${s[0].length},1fr)`;
    s.flat().forEach(v=>{
      const d=document.createElement('div');
      if(v){d.className='piece-cell';d.style.setProperty('--c1',col.c1);d.style.setProperty('--c2',col.c2);}
      p.appendChild(d);
    });
    p.onpointerdown=e=>startDrag(e,p);
    piecesEl.appendChild(p);
  }
}
renderBoard();spawn();

/* Restart without reload */
document.getElementById('restartBtn').onclick=()=>{
  board.forEach(r=>r.fill(null));
  score=0;scoreEl.textContent=0;
  document.querySelectorAll('.cell').forEach(c=>{c.className='cell';c.style.background=''});
  overlay.classList.remove('show');
  spawn();
};

</script>
</body>
</html>
