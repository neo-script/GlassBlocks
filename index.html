<!--
GlassBlocks
STABLE VERSION + MINIMAL ADDITIONS
Audio fixed
Flip/Rotate abilities added safely
-->

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>GlassBlocks</title>

<link rel="icon" href="favicon.ico">
<link href="https://fonts.googleapis.com/css2?family=Shizuru&display=swap" rel="stylesheet">

<style>
/* --- (CSS unchanged from last stable version) --- */
body{
  margin:0;
  font-family:'Shizuru', cursive;
  background: radial-gradient(circle at top,#1e293b,#0f172a);
  color:white;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
  overflow:hidden;
}
.game{ width:520px; max-width:94vw; }
.board{
  display:grid;
  grid-template-columns:repeat(8,1fr);
  gap:6px;
  padding:6px;
  background:rgba(30,41,59,.75);
  border-radius:22px;
  aspect-ratio:1;
}
.cell{
  background:rgba(15,23,42,.65);
  border-radius:10px;
}
.cell.filled{ box-shadow:0 0 12px var(--glow); }
.tray{
  margin-top:16px;
  padding:22px;
  min-height:210px;
  background:rgba(30,41,59,.55);
  border-radius:22px;
}
.pieces{ display:flex; justify-content:space-around; height:150px; }
.piece{ display:grid; gap:6px; padding:10px; cursor:grab; }
.piece.dragging{ opacity:0; }
.piece-cell{
  width:24px; height:24px;
  border-radius:6px;
  background:linear-gradient(135deg,var(--c1),var(--c2));
}
.drag-proxy{
  position:fixed;
  pointer-events:none;
  display:grid;
  gap:6px;
  padding:10px;
  z-index:999;
}
.audio-btn{
  position:fixed; bottom:14px; right:14px;
  background:rgba(30,41,59,.7);
  padding:10px 14px;
  border-radius:999px;
  cursor:pointer;
}
.ability{
  position:fixed; top:14px; left:50%;
  transform:translateX(-50%);
  opacity:.85;
}
</style>
</head>

<body>

<audio id="bgm" src="music.mp3" loop></audio>
<audio id="sfx" src="click.mp3"></audio>

<div id="ability" class="ability"></div>
<button id="audioBtn" class="audio-btn">ðŸ”‡</button>

<div class="game">
  <div id="board" class="board"></div>
  <div class="tray"><div id="pieces" class="pieces"></div></div>
</div>

<div id="proxy" class="drag-proxy" style="display:none;"></div>

<script>
/* ---------- AUDIO (stable) ---------- */
const bgm = document.getElementById('bgm');
const sfx = document.getElementById('sfx');
const audioBtn = document.getElementById('audioBtn');

let audioEnabled = false;
let unlocked = false;

function unlockAudio(){
  if(unlocked) return;
  unlocked = true;
  bgm.volume = .35;
  sfx.volume = .6;
  bgm.play().then(()=>bgm.pause()).catch(()=>{});
}
audioBtn.onclick = () => {
  unlockAudio();
  audioEnabled = !audioEnabled;
  audioBtn.textContent = audioEnabled ? 'ðŸ”Š' : 'ðŸ”‡';
  if(audioEnabled) bgm.play().catch(()=>{});
  else bgm.pause();
};
window.addEventListener('pointerdown', unlockAudio, { once:true });
function playClick(){
  if(!audioEnabled) return;
  sfx.currentTime = 0;
  sfx.play().catch(()=>{});
}

/* ---------- GAME ---------- */
const GRID = 8;
const COLORS = [
  {c1:'#22d3ee',c2:'#67e8f9'},
  {c1:'#a78bfa',c2:'#c4b5fd'},
  {c1:'#34d399',c2:'#6ee7b7'},
  {c1:'#f472b6',c2:'#f9a8d4'},
  {c1:'#facc15',c2:'#fde68a'}
];
const SHAPES = [
  [[1]],[[1,1]],[[1,1,1]],[[1,1,1,1]],
  [[1,1],[1,1]],[[1,1,1],[0,1,0]],
  [[0,1,1],[1,1,0]],[[1,0],[1,0],[1,1]]
];

let board = Array.from({length:GRID},()=>Array(GRID).fill(null));
let ability = null; // 'flip' | 'rotate'

const boardEl = document.getElementById('board');
const piecesEl = document.getElementById('pieces');
const proxy = document.getElementById('proxy');
const abilityEl = document.getElementById('ability');

/* board render */
for(let r=0;r<GRID;r++)
  for(let c=0;c<GRID;c++){
    const d=document.createElement('div');
    d.className='cell';
    d.dataset.r=r; d.dataset.c=c;
    boardEl.appendChild(d);
  }

/* helpers */
const flip = s => s.map(r=>[...r].reverse());
const rotate = s => s[0].map((_,i)=>s.map(r=>r[i]).reverse());
const clone = s => s.map(r=>[...r]);

/* spawn */
function spawn(){
  piecesEl.innerHTML='';
  for(let i=0;i<3;i++){
    const shape = clone(SHAPES[Math.random()*SHAPES.length|0]);
    const col = COLORS[Math.random()*COLORS.length|0];
    const p=document.createElement('div');
    p.className='piece';
    p._shape=shape;
    p._color=col;
    p.style.gridTemplateColumns=`repeat(${shape[0].length},1fr)`;
    shape.flat().forEach(v=>{
      const d=document.createElement('div');
      if(v){
        d.className='piece-cell';
        d.style.setProperty('--c1',col.c1);
        d.style.setProperty('--c2',col.c2);
      }
      p.appendChild(d);
    });
    p.onpointerdown=e=>startDrag(e,p);
    piecesEl.appendChild(p);
  }
}
spawn();

/* drag */
let drag=null;
function startDrag(e,p){
  unlockAudio();
  drag={
    piece:p,
    shape:clone(p._shape),
    color:p._color,
    ox:e.offsetX, oy:e.offsetY
  };

  if(ability==='flip') drag.shape = flip(drag.shape);
  if(ability==='rotate') drag.shape = rotate(drag.shape);

  ability=null;
  abilityEl.textContent='';

  p.classList.add('dragging');
  proxy.innerHTML='';
  proxy.style.display='grid';
  proxy.style.gridTemplateColumns=`repeat(${drag.shape[0].length},1fr)`;

  drag.shape.flat().forEach(v=>{
    const d=document.createElement('div');
    if(v){
      d.className='piece-cell';
      d.style.setProperty('--c1',drag.color.c1);
      d.style.setProperty('--c2',drag.color.c2);
    }
    proxy.appendChild(d);
  });

  window.onpointermove=e=>{
    proxy.style.left=e.clientX-drag.ox+'px';
    proxy.style.top=e.clientY-drag.oy+'px';
  };
  window.onpointerup=e=>drop(e);
}

function canPlace(s,r,c){
  for(let i=0;i<s.length;i++)
    for(let j=0;j<s[i].length;j++)
      if(s[i][j]){
        if(!board[r+i]||board[r+i][c+j]) return false;
      }
  return true;
}

function drop(e){
  window.onpointermove=null;
  window.onpointerup=null;

  const rect=boardEl.getBoundingClientRect();
  const size=rect.width/GRID;
  const r=Math.round((e.clientY-rect.top)/size);
  const c=Math.round((e.clientX-rect.left)/size);

  if(canPlace(drag.shape,r,c)){
    drag.shape.forEach((row,i)=>row.forEach((v,j)=>{
      if(v){
        board[r+i][c+j]=drag.color;
        const el=document.querySelector(
          `.cell[data-r="${r+i}"][data-c="${c+j}"]`);
        el.classList.add('filled');
        el.style.background=`linear-gradient(135deg,
          ${drag.color.c1},${drag.color.c2})`;
        el.style.setProperty('--glow',drag.color.c2);
      }
    }));
    playClick();
    drag.piece.remove();
    clearLines();
    if(!piecesEl.children.length) spawn();
  }else{
    drag.piece.classList.remove('dragging');
  }
  proxy.style.display='none';
  drag=null;
}

/* clearing + ability chance */
function clearLines(){
  let cleared=false;

  for(let r=0;r<GRID;r++)
    if(board[r].every(v=>v)){
      board[r].fill(null);
      document
        .querySelectorAll(`.cell[data-r="${r}"]`)
        .forEach(c=>c.className='cell');
      cleared=true;
    }

  for(let c=0;c<GRID;c++)
    if(board.every(r=>r[c])){
      board.forEach(r=>r[c]=null);
      document
        .querySelectorAll(`.cell[data-c="${c}"]`)
        .forEach(cel=>cel.className='cell');
      cleared=true;
    }

  if(cleared){
    playClick();
    const roll=Math.random();
    if(roll<0.15){
      ability='flip';
      abilityEl.textContent='Flip ready â¬Œ';
    }else if(roll<0.30){
      ability='rotate';
      abilityEl.textContent='Rotate ready âŸ³';
    }
  }
}
</script>
</body>
</html>
